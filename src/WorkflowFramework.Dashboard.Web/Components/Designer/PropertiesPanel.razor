@inject DashboardApiClient Api

<div class="w-80 bg-gray-800 border-l border-gray-700 overflow-y-auto flex-shrink-0" data-testid="properties-panel">
    @if (SelectedNodeId is null)
    {
        <div class="p-4 text-gray-500 text-sm text-center mt-8">
            <p class="text-2xl mb-2">ðŸ”§</p>
            <p>Select a step on the canvas to edit its properties</p>
        </div>
    }
    else
    {
        var stepDef = _localSteps.FirstOrDefault(s => s.Type == SelectedNodeType);
        var categoryColor = stepDef?.Color ?? StepCatalog.CategoryColors.GetValueOrDefault(stepDef?.Category ?? "", "#6b7280");

        @* Header with icon, name, type badge, category *@
        <div class="p-3 border-b border-gray-700" data-testid="properties-header">
            <div class="flex items-center gap-2 mb-1">
                <span class="text-lg">@(stepDef?.Icon ?? "â¬¡")</span>
                <span class="text-sm font-semibold text-gray-100 flex-1 truncate">@(NodeConfig.GetValueOrDefault("label")?.ToString() ?? stepDef?.Name ?? SelectedNodeType)</span>
            </div>
            <div class="flex items-center gap-1.5 mt-1">
                <span class="px-1.5 py-0.5 rounded text-[10px] font-medium" style="background: @(categoryColor)22; color: @categoryColor">@(stepDef?.Category ?? "Unknown")</span>
                <span class="px-1.5 py-0.5 rounded bg-gray-700 text-gray-400 text-[10px] font-mono">@SelectedNodeType</span>
            </div>
        </div>

        @* Step type description *@
        @if (_stepTypeDescription is not null)
        {
            <div class="px-3 py-2 border-b border-gray-700 text-xs text-gray-400 italic" data-testid="properties-description">
                @_stepTypeDescription
            </div>
        }

        @if (_loadingSchema)
        {
            <div class="p-3 text-gray-500 text-xs animate-pulse">Loading schema...</div>
        }

        <div class="p-3 space-y-3">
            @* Step Name *@
            <div>
                <label class="block text-xs text-gray-400 mb-1">Step Name</label>
                <input type="text" value="@(NodeConfig.GetValueOrDefault("label")?.ToString() ?? string.Empty)"
                       @oninput='e => UpdateConfig("label", e.Value)'
                       data-testid="properties-step-name"
                       class="w-full bg-gray-700 text-gray-200 text-sm px-2 py-1 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" />
            </div>

            @* Notes/Description *@
            <div>
                <label class="block text-xs text-gray-400 mb-1">Notes</label>
                <textarea rows="2"
                          @oninput='e => UpdateConfig("_notes", e.Value)'
                          data-testid="properties-notes"
                          class="w-full bg-gray-700 text-gray-200 text-sm px-2 py-1 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 resize-y">@(NodeConfig.GetValueOrDefault("_notes")?.ToString() ?? string.Empty)</textarea>
            </div>

            @* Connections *@
            @if (Connections is not null && (Connections.Inputs.Count > 0 || Connections.Outputs.Count > 0))
            {
                <div class="border-t border-gray-700 pt-2" data-testid="properties-connections">
                    <label class="block text-xs text-gray-400 mb-1.5 uppercase tracking-wider font-semibold">Connections</label>
                    @if (Connections.Inputs.Count > 0)
                    {
                        <div class="mb-1.5">
                            <span class="text-[10px] text-gray-500 uppercase">Inputs from:</span>
                            <div class="flex flex-wrap gap-1 mt-0.5">
                                @foreach (var input in Connections.Inputs)
                                {
                                    <button @onclick="() => OnConnectionClicked.InvokeAsync(input.Id)"
                                            class="px-1.5 py-0.5 rounded bg-gray-700 text-gray-300 text-[10px] hover:bg-gray-600 cursor-pointer">
                                        @if (input.EdgeLabel is not null) { <span class="text-gray-500 mr-0.5">@input.EdgeLabel:</span> }
                                        @input.Label
                                    </button>
                                }
                            </div>
                        </div>
                    }
                    @if (Connections.Outputs.Count > 0)
                    {
                        <div>
                            <span class="text-[10px] text-gray-500 uppercase">Outputs to:</span>
                            <div class="flex flex-wrap gap-1 mt-0.5">
                                @foreach (var output in Connections.Outputs)
                                {
                                    <button @onclick="() => OnConnectionClicked.InvokeAsync(output.Id)"
                                            class="px-1.5 py-0.5 rounded bg-gray-700 text-gray-300 text-[10px] hover:bg-gray-600 cursor-pointer">
                                        @if (output.EdgeLabel is not null) { <span class="text-gray-500 mr-0.5">@output.EdgeLabel:</span> }
                                        @output.Label
                                    </button>
                                }
                            </div>
                        </div>
                    }
                </div>
            }

            @* Children for container steps *@
            @if (Connections is not null && IsContainerType(SelectedNodeType) && Connections.Outputs.Count > 0)
            {
                <div class="border-t border-gray-700 pt-2" data-testid="properties-children">
                    <label class="block text-xs text-gray-400 mb-1.5 uppercase tracking-wider font-semibold">Child Steps</label>
                    <div class="space-y-0.5">
                        @foreach (var child in Connections.Outputs)
                        {
                            <button @onclick="() => OnConnectionClicked.InvokeAsync(child.Id)"
                                    class="w-full flex items-center gap-1.5 px-2 py-1 rounded text-left hover:bg-gray-700 text-xs">
                                @if (child.EdgeLabel is not null) { <span class="text-gray-500 font-mono text-[10px]">@child.EdgeLabel</span> }
                                <span class="text-gray-200">@child.Label</span>
                            </button>
                        }
                    </div>
                </div>
            }

            @* Schema-driven configuration fields *@
            @if (_schemaFields.Count > 0)
            {
                <div class="border-t border-gray-700 pt-2">
                    <label class="block text-xs text-gray-400 mb-1.5 uppercase tracking-wider font-semibold">Configuration</label>
                    @foreach (var field in _schemaFields)
                    {
                        <div class="mb-3">
                            <label class="block text-xs text-gray-400 mb-1">
                                @field.Label
                                @if (field.Required) { <span class="text-red-400 ml-0.5">*</span> }
                            </label>

                            @switch (field.UiType)
                            {
                                case "providerSelect":
                                    <select value="@GetConfigValue(field)"
                                            @onchange='e => UpdateConfig(field.Name, e.Value)'
                                            class="w-full bg-gray-700 text-gray-200 text-sm px-2 py-1 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                        <option value="">â€” Select provider â€”</option>
                                        <option value="ollama">Ollama</option>
                                        <option value="openai">OpenAI</option>
                                        <option value="anthropic">Anthropic</option>
                                        <option value="huggingface">HuggingFace</option>
                                    </select>
                                    break;

                                case "modelSelect":
                                    <select value="@GetConfigValue(field)"
                                            @onchange='e => UpdateConfig(field.Name, e.Value)'
                                            class="w-full bg-gray-700 text-gray-200 text-sm px-2 py-1 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                        <option value="">â€” Select model â€”</option>
                                        @foreach (var m in GetModelsForProvider(field.DependsOn is not null ? NodeConfig.GetValueOrDefault(field.DependsOn)?.ToString() ?? "" : ""))
                                        {
                                            <option value="@m">@m</option>
                                        }
                                    </select>
                                    break;

                                case "select":
                                    <select value="@GetConfigValue(field)"
                                            @onchange='e => UpdateConfig(field.Name, e.Value)'
                                            class="w-full bg-gray-700 text-gray-200 text-sm px-2 py-1 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                        <option value="">â€” Select â€”</option>
                                        @if (field.Options is not null)
                                        {
                                            @foreach (var opt in field.Options)
                                            {
                                                <option value="@opt">@opt</option>
                                            }
                                        }
                                    </select>
                                    break;

                                case "textarea":
                                    <textarea rows="@(field.Rows > 0 ? field.Rows : 3)"
                                              placeholder="@(field.Default ?? "")"
                                              @oninput='e => UpdateConfig(field.Name, e.Value)'
                                              class="w-full bg-gray-700 text-gray-200 text-sm px-2 py-1 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 resize-y">@(NodeConfig.GetValueOrDefault(field.Name)?.ToString() ?? string.Empty)</textarea>
                                    break;

                                case "json":
                                    <textarea rows="@(field.Rows > 0 ? field.Rows : 4)"
                                              placeholder="@(field.Default ?? "")"
                                              @oninput='e => UpdateConfig(field.Name, e.Value)'
                                              class="w-full bg-gray-700 text-gray-200 text-sm px-2 py-1 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 resize-y font-mono text-xs">@(NodeConfig.GetValueOrDefault(field.Name)?.ToString() ?? string.Empty)</textarea>
                                    break;

                                case "slider":
                                    <div class="flex items-center gap-2">
                                        <input type="range"
                                               min="@field.Min" max="@field.Max" step="@(field.Step > 0 ? field.Step : 1)"
                                               value="@(NodeConfig.GetValueOrDefault(field.Name)?.ToString() ?? field.Default ?? "0")"
                                               @oninput='e => UpdateConfig(field.Name, e.Value)'
                                               class="flex-1 accent-blue-500" />
                                        <span class="text-xs text-gray-300 w-10 text-right font-mono">@(NodeConfig.GetValueOrDefault(field.Name)?.ToString() ?? field.Default ?? "0")</span>
                                    </div>
                                    break;

                                case "number":
                                    <input type="number"
                                           value="@GetConfigValue(field)"
                                           placeholder="@(field.Default ?? "")"
                                           min="@(field.Min)" max="@(field.Max)" step="@(field.Step > 0 ? field.Step : 1)"
                                           @oninput='e => UpdateConfig(field.Name, e.Value)'
                                           class="w-full bg-gray-700 text-gray-200 text-sm px-2 py-1 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" />
                                    break;

                                case "boolean":
                                    <label class="inline-flex items-center gap-2 cursor-pointer">
                                        <div class="relative">
                                            <input type="checkbox"
                                                   checked="@IsBoolChecked(field)"
                                                   @onchange='e => UpdateConfig(field.Name, (bool)(e.Value ?? false) ? "true" : "false")'
                                                   class="sr-only peer" />
                                            <div class="w-9 h-5 bg-gray-600 rounded-full peer peer-checked:bg-blue-500 transition-colors"></div>
                                            <div class="absolute left-0.5 top-0.5 w-4 h-4 bg-white rounded-full transition-transform peer-checked:translate-x-4"></div>
                                        </div>
                                        <span class="text-xs text-gray-300">@(IsBoolChecked(field) ? "Enabled" : "Disabled")</span>
                                    </label>
                                    break;

                                case "password":
                                    <input type="password"
                                           value="@GetConfigValue(field)"
                                           placeholder="@(field.Default ?? "")"
                                           @oninput='e => UpdateConfig(field.Name, e.Value)'
                                           class="w-full bg-gray-700 text-gray-200 text-sm px-2 py-1 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" />
                                    break;

                                default:
                                    <input type="text"
                                           value="@GetConfigValue(field)"
                                           placeholder="@(field.Default ?? "")"
                                           @oninput='e => UpdateConfig(field.Name, e.Value)'
                                           class="w-full bg-gray-700 text-gray-200 text-sm px-2 py-1 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" />
                                    break;
                            }

                            @if (field.HelpText is not null)
                            {
                                <p class="text-[10px] text-gray-500 mt-0.5">@field.HelpText</p>
                            }
                        </div>
                    }
                </div>
            }
            else if (stepDef is not null && stepDef.Properties.Count > 0)
            {
                <div class="border-t border-gray-700 pt-2">
                    <label class="block text-xs text-gray-400 mb-1.5 uppercase tracking-wider font-semibold">Configuration</label>
                    @foreach (var prop in stepDef.Properties)
                    {
                        <div class="mb-2">
                            <label class="block text-xs text-gray-400 mb-1">
                                @prop.Label
                                @if (prop.Required) { <span class="text-red-400">*</span> }
                            </label>
                            @if (prop.Type == "select" && prop.Options is not null)
                            {
                                <select value="@(NodeConfig.GetValueOrDefault(prop.Name)?.ToString() ?? prop.DefaultValue ?? string.Empty)"
                                        @onchange='e => UpdateConfig(prop.Name, e.Value)'
                                        class="w-full bg-gray-700 text-gray-200 text-sm px-2 py-1 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                    @foreach (var opt in prop.Options)
                                    {
                                        <option value="@opt">@opt</option>
                                    }
                                </select>
                            }
                            else if (prop.Type == "bool")
                            {
                                <input type="checkbox"
                                       checked="@(NodeConfig.GetValueOrDefault(prop.Name)?.ToString() == "true")"
                                       @onchange='e => UpdateConfig(prop.Name, e.Value)'
                                       class="rounded bg-gray-700" />
                            }
                            else
                            {
                                <input type="@(prop.Type == "number" ? "number" : "text")"
                                       value="@(NodeConfig.GetValueOrDefault(prop.Name)?.ToString() ?? prop.DefaultValue ?? string.Empty)"
                                       @oninput='e => UpdateConfig(prop.Name, e.Value)'
                                       class="w-full bg-gray-700 text-gray-200 text-sm px-2 py-1 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" />
                            }
                        </div>
                    }
                </div>
            }
        </div>
    }
</div>

@code {
    [Parameter] public string? SelectedNodeId { get; set; }
    [Parameter] public string? SelectedNodeType { get; set; }
    [Parameter] public Dictionary<string, object?> NodeConfig { get; set; } = new();
    [Parameter] public EventCallback<Dictionary<string, object?>> OnConfigChanged { get; set; }
    [Parameter] public NodeConnections? Connections { get; set; }
    [Parameter] public EventCallback<string> OnConnectionClicked { get; set; }

    private List<StepDefinition> _localSteps = StepCatalog.GetAll();
    private bool _loadingSchema;
    private List<SchemaField> _schemaFields = [];
    private string? _lastLoadedType;
    private string? _stepTypeDescription;

    public sealed class NodeConnections
    {
        public List<ConnectionInfo> Inputs { get; set; } = [];
        public List<ConnectionInfo> Outputs { get; set; } = [];
    }

    public sealed class ConnectionInfo
    {
        public string Id { get; set; } = "";
        public string Label { get; set; } = "";
        public string? EdgeLabel { get; set; }
    }

    private sealed class SchemaField
    {
        public string Name { get; set; } = "";
        public string Label { get; set; } = "";
        public string UiType { get; set; } = "text";
        public string? HelpText { get; set; }
        public bool Required { get; set; }
        public int Rows { get; set; }
        public double Min { get; set; }
        public double Max { get; set; } = 100;
        public double Step { get; set; }
        public string? Default { get; set; }
        public string? DependsOn { get; set; }
        public List<string>? Options { get; set; }
    }

    private static bool IsContainerType(string? type) => type?.ToLowerInvariant() is
        "parallel" or "conditional" or "trycatch" or "saga" or "foreach" or "while" or "dowhile" or "retry";

    private string GetConfigValue(SchemaField field)
    {
        return NodeConfig.GetValueOrDefault(field.Name)?.ToString() ?? string.Empty;
    }

    private bool IsBoolChecked(SchemaField field)
    {
        var val = NodeConfig.GetValueOrDefault(field.Name)?.ToString()?.ToLowerInvariant();
        return val == "true" || (val is null && field.Default == "true");
    }

    private static List<string> GetModelsForProvider(string provider) => provider?.ToLowerInvariant() switch
    {
        "ollama"      => ["llama3.1", "llama3.2", "mistral", "codellama", "phi3", "gemma2", "qwen2.5"],
        "openai"      => ["gpt-4o", "gpt-4o-mini", "gpt-4-turbo", "gpt-3.5-turbo", "o1", "o1-mini"],
        "anthropic"   => ["claude-sonnet-4-20250514", "claude-3-5-haiku-20241022", "claude-3-opus-20240229"],
        "huggingface" => ["meta-llama/Llama-3.1-8B", "mistralai/Mistral-7B-v0.3", "google/gemma-2-9b"],
        _             => []
    };

    protected override async Task OnParametersSetAsync()
    {
        if (SelectedNodeType is not null && SelectedNodeType != _lastLoadedType)
        {
            _lastLoadedType = SelectedNodeType;
            await LoadSchema(SelectedNodeType);
        }
        else if (SelectedNodeType is null)
        {
            _lastLoadedType = null;
            _schemaFields = [];
            _stepTypeDescription = null;
        }
    }

    private async Task LoadSchema(string type)
    {
        _loadingSchema = true;
        _schemaFields = [];
        _stepTypeDescription = null;
        try
        {
            var info = await Api.GetStepTypeAsync(type);
            if (info is not null)
            {
                _stepTypeDescription = info.Description;
                if (info.ConfigSchema is not null)
                {
                    var schema = info.ConfigSchema.Value;
                    // Collect top-level required array
                    var topRequired = new HashSet<string>();
                    if (schema.TryGetProperty("required", out var reqArray) && reqArray.ValueKind == System.Text.Json.JsonValueKind.Array)
                    {
                        foreach (var r in reqArray.EnumerateArray())
                            topRequired.Add(r.GetString() ?? "");
                    }

                    if (schema.TryGetProperty("properties", out var props))
                    {
                        foreach (var prop in props.EnumerateObject())
                        {
                            var field = new SchemaField { Name = prop.Name };

                            // Label
                            field.Label = prop.Value.TryGetProperty("label", out var lbl)
                                ? lbl.GetString() ?? prop.Name
                                : prop.Name[..1].ToUpper() + prop.Name[1..];

                            // uiType
                            if (prop.Value.TryGetProperty("uiType", out var ui))
                                field.UiType = ui.GetString() ?? "text";
                            else if (prop.Value.TryGetProperty("type", out var t))
                            {
                                var schemaType = t.GetString();
                                field.UiType = schemaType == "boolean" ? "boolean" : schemaType == "number" ? "number" : "text";
                            }

                            // Required (field-level or top-level)
                            if (prop.Value.TryGetProperty("required", out var req) && req.ValueKind == System.Text.Json.JsonValueKind.True)
                                field.Required = true;
                            else if (topRequired.Contains(prop.Name))
                                field.Required = true;

                            // HelpText
                            if (prop.Value.TryGetProperty("helpText", out var ht))
                                field.HelpText = ht.GetString();

                            // Rows
                            if (prop.Value.TryGetProperty("rows", out var rows))
                                field.Rows = rows.GetInt32();

                            // Min/Max/Step
                            if (prop.Value.TryGetProperty("min", out var mn))
                                field.Min = mn.GetDouble();
                            if (prop.Value.TryGetProperty("max", out var mx))
                                field.Max = mx.GetDouble();
                            if (prop.Value.TryGetProperty("step", out var st))
                                field.Step = st.GetDouble();

                            // Default
                            if (prop.Value.TryGetProperty("default", out var def))
                                field.Default = def.ToString();

                            // DependsOn
                            if (prop.Value.TryGetProperty("dependsOn", out var dep))
                                field.DependsOn = dep.GetString();

                            // Options (from enum or options array)
                            if (prop.Value.TryGetProperty("options", out var opts) && opts.ValueKind == System.Text.Json.JsonValueKind.Array)
                            {
                                field.Options = [];
                                foreach (var o in opts.EnumerateArray())
                                    field.Options.Add(o.GetString() ?? "");
                            }
                            else if (prop.Value.TryGetProperty("enum", out var en) && en.ValueKind == System.Text.Json.JsonValueKind.Array)
                            {
                                field.Options = [];
                                field.UiType = field.UiType == "text" ? "select" : field.UiType;
                                foreach (var o in en.EnumerateArray())
                                    field.Options.Add(o.GetString() ?? "");
                            }

                            _schemaFields.Add(field);
                        }
                    }
                }
            }
        }
        catch { /* fall back to local step definitions */ }
        finally { _loadingSchema = false; }
    }

    private async Task UpdateConfig(string key, object? value)
    {
        var newConfig = new Dictionary<string, object?>(NodeConfig) { [key] = value };
        await OnConfigChanged.InvokeAsync(newConfig);
    }
}
